<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XREX OTC Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            min-height: 100vh;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            text-align: center;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            margin: 0;
            color: var(--tg-theme-text-color, #000000);
            font-size: 24px;
        }
        
        .user-info {
            font-size: 14px;
            color: var(--tg-theme-subtitle-text-color, #666666);
            text-align: center;
            margin: 30px 0;
            padding: 20px;
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 8px;
        }
        
        .instructions {
            margin: 20px 0;
            padding: 15px;
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè¶ XREX OTC</h1>
            <p>Fast Telegram OTC Trading</p>
        </div>
        
        <div class="instructions">
            <p><strong>Simple Test:</strong></p>
            <p>Click the "Request Quote" button at the bottom to send a quote request to the chat.</p>
        </div>
        
        <div class="user-info">
            <div><strong>User:</strong> <span id="userName">Loading...</span></div>
            <div><strong>User ID:</strong> <span id="userId">Loading...</span></div>
            <div><strong>Timestamp:</strong> <span id="timestamp">Loading...</span></div>
        </div>
    </div>
    
    <script>
        // Add timestamp for cache busting
        document.getElementById('timestamp').textContent = new Date().toLocaleString();
        
        // Initialize Telegram Web App
        let tg = window.Telegram.WebApp;
        console.log('=== MINI APP DEBUG ===');
        console.log('Telegram WebApp object:', tg);
        console.log('WebApp version:', tg.version);
        console.log('WebApp available:', !!window.Telegram?.WebApp);
        
        tg.expand();
        tg.ready();
        
        // Get user info
        const user = tg.initDataUnsafe?.user;
        console.log('User data:', user);
        if (user) {
            document.getElementById('userName').textContent = user.first_name + (user.last_name ? ' ' + user.last_name : '');
            document.getElementById('userId').textContent = user.id;
        } else {
            document.getElementById('userName').textContent = 'Unknown';
            document.getElementById('userId').textContent = 'Unknown';
        }
        
        // Show Telegram's MainButton immediately
        tg.MainButton.setText('Request Quote');
        tg.MainButton.show();
        console.log('MainButton shown');
        
        // ALTERNATIVE APPROACH: Send data immediately on load for testing
        setTimeout(() => {
            console.log('=== TESTING AUTO-SEND ON LOAD ===');
            try {
                tg.sendData("QUOTE_REQUEST_AUTO");
                console.log('Auto data sent successfully - waiting for transmission...');
                
                // Don't close immediately - let it stay open for debugging
                console.log('Auto-send completed, app will stay open for debugging');
            } catch (error) {
                console.error('Auto send failed:', error);
            }
        }, 2000); // Wait 2 seconds then auto-send
        
        // Handle MainButton click (keep this as backup)
        tg.MainButton.onClick(function() {
            console.log('=== BUTTON CLICKED ===');
            console.log('Sending QUOTE_REQUEST...');
            
            // Show immediate feedback
            tg.MainButton.setText('Sending...');
            
            try {
                tg.sendData("QUOTE_REQUEST");
                console.log('Data sent successfully - allowing time for transmission...');
                
                // Show success feedback
                tg.MainButton.setText('Sent! ‚úÖ');
                
                // Haptic feedback
                if (tg.HapticFeedback) {
                    tg.HapticFeedback.impactOccurred('medium');
                }
                
                // Close after a longer delay to ensure data transmission
                setTimeout(() => {
                    console.log('Closing mini app after data transmission...');
                    tg.close();
                }, 3000); // 3 seconds should be enough for data to reach bot
                
            } catch (error) {
                console.error('Error:', error);
                tg.MainButton.setText('Error ‚ùå');
                alert('Error: ' + error.message);
            }
        });
        
        // Show back button
        tg.BackButton.show();
        tg.onEvent('backButtonClicked', function() {
            tg.close();
        });
        
        console.log('=== INITIALIZATION COMPLETE ===');
    </script>
</body>
</html> 